ORG 0000H
LJMP START
ORG 0100H
START:
MAIN:
	;---DN2CH TEST---
	MOV R4,#7H
	MOV R5,#0CEH

	SETB RS1
	SETB RS0
	MOV R2,#07H
	MOV R3,#0CEH
	LCALL DBN2CHR
	LCALL DBN2DIS

	;LCALL NUM2CH
	CLR RS0
	CLR RS1

	LJMP $
;-----------------------DN2CH 3FH,3EH中的双字节数转BCD存放在R4-R6-----------------------
DBN2CHR:MOV R4,#0
	MOV R5,#0
	MOV R6,#0
	MOV R7,#16
DBN2LOP:MOV A,R3		;双字节数移位操作
	RLC A
	MOV R3,A
	MOV A,R2
	RLC A
	MOV R2,A
	MOV A,R6
	RLC A
	MOV R6,A
	MOV A,R5
	RLC A
	MOV R5,A
	MOV A,R4
	RLC A
	MOV R4,A
	CJNE R7,#1,DBN2JMO 	;最后一次不作调整
	RET
DBN2JMO:CLR C
	MOV A,R6
	ANL A,#0FH
	SUBB A,#5
	JC DBN2JMA		;当前BCD位值大于4则进行+3调整
	MOV A,R6
	ADD A,#3
	MOV R6,A
DBN2JMA:CLR C
	MOV A,R6
	ANL A,#0F0H
	SUBB A,#50H
	JC DBN2JMB
	MOV A,R6
	ADD A,#30H
	MOV R6,A
DBN2JMB:CLR C
	MOV A,R5
	ANL A,#0FH
	SUBB A,#5
	JC DBN2JMC
	MOV A,R5
	ADD A,#3
	MOV R5,A
DBN2JMC:CLR C
	MOV A,R5
	ANL A,#0F0H
	SUBB A,#50H
	JC DBN2JMD
	MOV A,R5
	ADD A,#30H
	MOV R5,A
DBN2JMD:CLR C
	MOV A,R4
	ANL A,#0FH
	SUBB A,#5
	JC DBN2JME
	MOV A,R4
	ADD A,#3
	MOV R4,A	
DBN2JME:CLR C
	MOV A,R4
	ANL A,#0F0H
	SUBB A,#50H
	JC DBN2JMF
	MOV A,R4
	ADD A,#30H
	MOV R4,A
DBN2JMF:DJNZ R7,DBN2LOP
	RET
;-----------------------DN2DIS-----------------------
DBN2DIS:MOV R1,#0
	MOV A,R4
	ANL A,#0FH
	CJNE R1,#0,DBN2DSA
	JZ DBN2DIA
DBN2DSA:INC R1
	LCALL DBNDISP
DBN2DIA:MOV A,R5
	SWAP A
	ANL A,#0FH
	CJNE R1,#0,DBN2DSB
	JZ DBN2DIB
DBN2DSB:INC R1
	LCALL DBNDISP
DBN2DIB:MOV A,R5
	ANL A,#0FH
	CJNE R1,#0,DBN2DSC
	JZ DBN2DIC
DBN2DSC:INC R1
	LCALL DBNDISP
DBN2DIC:MOV A,R6
	SWAP A
	ANL A,#0FH
	CJNE R1,#0,DBN2DSD
	JZ DBN2DID
DBN2DSD:INC R1
	LCALL DBNDISP
DBN2DID:MOV A,R6
	ANL A,#0FH
	LCALL DBNDISP
	RET

DBNDISP:
	RET

;------NUMBER TO CHAR-------R2R3双字节数转ASCII并保存到20H-24H中
NUM2CH:MOV 20H,#0
	MOV 21H,#0
	MOV 22H,#0
	MOV 23H,#0
	MOV 24H,#0
	MOV R4,#0
	MOV R5,#0AH
	MOV R0,#20H
N2CHR:LCALL DBLDIV
	MOV A,R3
	ADD A,#30H
	MOV @R0,A
	MOV A,R6
	MOV R2,A
	MOV A,R7
	MOV R3,A
	INC R0
	CJNE R6,#0,N2CHR
	CJNE R7,#0,N2CHR
	RET
;------Double Byte DIV-------(R2R3)/(R4R5) -> R6R7, % -> R2R3
;使用了R1-R7,A,B,C
DBLDIV:MOV R6,#0
	MOV R7,#0
	MOV B,#0
DBDIVA:	CLR C;数据对齐
	MOV A,R3	
	SUBB A,R5
	MOV R1,A
	MOV A,R2
	SUBB A,R4
	JC DBDIVB;已对齐
	MOV A,R4
	MOV A,R5
	RLC A
	MOV R5,A
	MOV A,R4
	RLC A
	MOV R4,A
	INC B
	MOV A,R4
	JNB ACC.7,DBDVAO
	LJMP DBDVBM	;至到最后一位对齐
DBDVAO:	MOV A,B
	CJNE A,#16,DBDIVA
	LJMP DBLDIVO ;除数为零直接返回
DBDIVB:CPL C ;移位求差
	MOV A,R7
	RLC A
	MOV R7,A
	MOV A,R6
	RLC A
	MOV R6,A
	MOV A,B
	JZ DBLDIVO;结束放这儿，商的最后一位要移入
	CLR C
	MOV A,R4
	RRC A
	MOV R4,A
	MOV A,R5
	RRC A
	MOV R5,A
	DEC B
DBDVBM:CLR C
	MOV A,R3
	SUBB A,R5
	MOV R1,A
	MOV A,R2
	SUBB A,R4
	JC DBDIVB;不够减直接上0
	MOV R2,A
	MOV A,R1
	MOV R3,A
	LJMP DBDIVB
DBLDIVO:RET
	
END
